<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>OmniStream Notifiers</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="theme.css">
  <style>
    body{font-family:Segoe UI,Arial;background:var(--bg);color:var(--text-main);margin:0;padding:0}
    .app-shell{display:flex;min-height:100vh;}
    .sidebar{width:220px;background:#050814;border-right:1px solid rgba(15,23,42,0.8);padding:18px 16px;box-sizing:border-box;display:flex;flex-direction:column;gap:18px;}
    .sidebar-brand{font-size:13px;font-weight:600;letter-spacing:0.14em;text-transform:uppercase;color:var(--text-muted);}
    .sidebar-nav{display:flex;flex-direction:column;gap:4px;margin-top:8px;}
    .nav-link{display:block;padding:8px 10px;border-radius:8px;font-size:13px;color:var(--text-muted);text-decoration:none;transition:background 0.15s,color 0.15s;}
    .nav-link:hover{background:rgba(148,163,184,0.15);color:var(--text-main);}
    .nav-link-active{background:rgba(59,130,246,0.18);color:#e5edff;border-left:3px solid var(--btn-border);padding-left:7px;}
    .settings-group{margin-top:4px;}
    .settings-submenu{display:none;flex-direction:column;gap:2px;padding-left:14px;margin-top:3px;}
    .settings-submenu.open{display:flex;}
    .submenu-link{display:block;padding:6px 10px;border-radius:8px;font-size:12px;color:var(--text-muted);text-decoration:none;}
    .submenu-link:hover{background:rgba(148,163,184,0.15);color:var(--text-main);}
    .submenu-link-active{background:rgba(59,130,246,0.18);color:#e5edff;}
    .sidebar-toggle{margin-bottom:10px;padding:4px 10px;border-radius:999px;border:1px solid var(--btn-border);background:var(--btn-bg);color:var(--btn-text);cursor:pointer;font-size:12px;}
    .sidebar-toggle:hover{background:var(--btn-bg-hover);color:var(--btn-text-hover);}
    .app-shell.sidebar-collapsed .sidebar{display:none;}
    .main-content{flex:1;box-sizing:border-box;padding:20px;}
    h1{margin:0 0 8px 0;color:var(--text-main);letter-spacing:0.5px;font-size:1.8em}
    .section{background:var(--card-bg);border-radius:14px;padding:16px 18px;box-shadow:0 2px 10px #0006;border:1px solid #2f3a52;margin-bottom:18px;max-width:640px;}
    .section h2{margin:0 0 8px 0;font-size:15px;color:var(--text-main);}
    label{display:block;font-size:13px;margin:6px 0;}
    input[type="text"],input[type="email"],input[type="number"],input[type="password"]{width:100%;max-width:420px;padding:6px 10px;border-radius:6px;border:1px solid #444;background:var(--bg);color:var(--text-main);}
    .inline{display:flex;gap:10px;align-items:center;}
    .hint{font-size:12px;color:var(--text-muted);margin-top:4px;}
    .btn{margin-top:12px;padding:6px 14px;border-radius:8px;border:1px solid var(--btn-border);background:var(--btn-bg);color:var(--btn-text);cursor:pointer;font-size:13px;}
    .btn:hover{background:var(--btn-bg-hover);color:var(--btn-text-hover);}
    .danger{border-color:#ff7043;color:#ffab91;}
    .status{font-size:12px;margin-top:8px;}
    .notifier-tabs{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 14px 0;}
    .notifier-tab{padding:4px 10px;border-radius:999px;border:1px solid var(--btn-border);background:transparent;color:var(--text-muted);font-size:12px;cursor:pointer;}
    .notifier-tab-active{background:var(--btn-bg);color:var(--btn-text);}
  </style>
</head>
<body>
  <div class="app-shell">
    <aside class="sidebar">
      <div class="sidebar-brand">OmniStream</div>
      <nav class="sidebar-nav">
        <a href="index.html" class="nav-link">Dashboard</a>
        <a href="history.html" class="nav-link">History</a>
        <a href="reports.html" class="nav-link">Reports</a>
        <a href="notifications.html" class="nav-link">Notifications</a>
        <div class="settings-group">
          <button type="button" class="nav-link nav-link-active settings-toggle">Settings</button>
          <div class="settings-submenu open">
            <a href="admin.html" class="submenu-link">Connected servers</a>
            <a href="servers.html" class="submenu-link">Servers</a>
            <a href="display.html" class="submenu-link">Themes &amp; layout</a>
            <a href="notifiers.html" class="submenu-link submenu-link-active">Notifiers</a>
            <a href="overseerr.html" class="submenu-link">Overseerr</a>
            <a href="system.html" class="submenu-link">System</a>
          </div>
        </div>
      </nav>
    </aside>
    <main class="main-content">
  <button class="sidebar-toggle" id="sidebarToggle">Hide menu</button>
  <h1>Settings</h1>
  <h2 style="margin:10px 0 12px 0;font-size:16px;color:var(--text-main);">Notifier settings</h2>

  <div class="section">
    <h2>Notification rules</h2>
    <label class="inline">
      <input type="checkbox" id="ruleOffline"> Notify when a server goes offline
    </label>
    <label class="inline">
      <input type="checkbox" id="ruleWanTranscodes"> Notify on WAN transcodes
    </label>
    <label class="inline">
      <input type="checkbox" id="ruleAnyWan"> Notify when any WAN stream is active
    </label>
    <label class="inline">
      <span style="flex:1;min-width:0;">
        Notify on high total bandwidth above (Mbps)
        <input type="number" id="ruleHighBandwidthThreshold" value="50" style="max-width:120px;">
      </span>
      <span class="inline" style="gap:4px;">
        <input type="checkbox" id="ruleHighBandwidth"> Enable high-bandwidth alerts
      </span>
    </label>
    <label class="inline">
      <span style="flex:1;min-width:0;">
        Notify on high WAN bandwidth above (Mbps)
        <input type="number" id="ruleHighWanThreshold" value="30" style="max-width:120px;">
      </span>
      <span class="inline" style="gap:4px;">
        <input type="checkbox" id="ruleHighWan"> Enable high-WAN-bandwidth alerts
      </span>
    </label>
    <div class="hint">These rules control when OmniStream generates alerts that are sent to your notifiers. Defaults are: offline, WAN transcodes, and bandwidth above 50 Mbps.</div>
  </div>

  <div class="notifier-tabs">
    <button type="button" class="notifier-tab" data-panel="email">Email</button>
    <button type="button" class="notifier-tab" data-panel="discord">Discord</button>
    <button type="button" class="notifier-tab" data-panel="webhook">Webhook</button>
    <button type="button" class="notifier-tab" data-panel="slack">Slack</button>
    <button type="button" class="notifier-tab" data-panel="telegram">Telegram</button>
    <button type="button" class="notifier-tab" data-panel="twilio">SMS (Twilio)</button>
    <button type="button" class="notifier-tab" data-panel="pushover">Pushover</button>
    <button type="button" class="notifier-tab" data-panel="gotify">Gotify</button>
  </div>

  <div class="section notifier-panel" data-panel="discord">
    <h2>Discord</h2>
    <label>
      Webhook URL
      <input type="text" id="discordWebhook" placeholder="https://discord.com/api/webhooks/...">
    </label>
    <div class="hint">Paste a Discord Incoming Webhook URL to receive alerts (offline servers, WAN transcodes, high bandwidth).</div>
    <label style="margin-top:10px;font-size:12px;font-weight:500;">Notification triggers</label>
    <label class="inline"><input type="checkbox" id="discordTrigOffline"> Offline servers</label>
    <label class="inline"><input type="checkbox" id="discordTrigWan"> WAN transcodes</label>
    <label class="inline"><input type="checkbox" id="discordTrigHigh"> High total bandwidth</label>
  </div>

  <div class="section notifier-panel" data-panel="webhook">
    <h2>Generic Webhook</h2>
    <label>
      Webhook URL
      <input type="text" id="webhookUrl" placeholder="https://your-service.example.com/webhook">
    </label>
    <div class="hint">Useful for Home Assistant, custom bots, or any service that accepts a simple JSON POST.</div>
    <label style="margin-top:10px;font-size:12px;font-weight:500;">Notification triggers</label>
    <label class="inline"><input type="checkbox" id="webhookTrigOffline"> Offline servers</label>
    <label class="inline"><input type="checkbox" id="webhookTrigWan"> WAN transcodes</label>
    <label class="inline"><input type="checkbox" id="webhookTrigHigh"> High total bandwidth</label>
  </div>

  <div class="section notifier-panel" data-panel="slack">
    <h2>Slack</h2>
    <label>
      Incoming Webhook URL
      <input type="text" id="slackWebhook" placeholder="https://hooks.slack.com/services/...">
    </label>
    <div class="hint">Use a Slack Incoming Webhook to post alerts into a channel.</div>
    <label style="margin-top:10px;font-size:12px;font-weight:500;">Notification triggers</label>
    <label class="inline"><input type="checkbox" id="slackTrigOffline"> Offline servers</label>
    <label class="inline"><input type="checkbox" id="slackTrigWan"> WAN transcodes</label>
    <label class="inline"><input type="checkbox" id="slackTrigHigh"> High total bandwidth</label>
  </div>

  <div class="section notifier-panel" data-panel="telegram">
    <h2>Telegram</h2>
    <label>
      Bot token
      <input type="text" id="telegramToken" placeholder="123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11">
    </label>
    <label>
      Chat ID
      <input type="text" id="telegramChat" placeholder="@your_channel or numeric chat id">
    </label>
    <div class="hint">Create a bot with @BotFather, then paste its token and the chat/channel ID where you want alerts.</div>
    <label style="margin-top:10px;font-size:12px;font-weight:500;">Notification triggers</label>
    <label class="inline"><input type="checkbox" id="telegramTrigOffline"> Offline servers</label>
    <label class="inline"><input type="checkbox" id="telegramTrigWan"> WAN transcodes</label>
    <label class="inline"><input type="checkbox" id="telegramTrigHigh"> High total bandwidth</label>
  </div>

  <div class="section notifier-panel" data-panel="twilio">
    <h2>SMS (Twilio)</h2>
    <label>
      Account SID
      <input type="text" id="twilioSid" placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
    </label>
    <label>
      Auth token
      <input type="password" id="twilioToken" placeholder="your_auth_token">
    </label>
    <label>
      From number
      <input type="text" id="twilioFrom" placeholder="+1234567890">
    </label>
    <label>
      To number
      <input type="text" id="twilioTo" placeholder="+1234567890">
    </label>
    <div class="hint">Twilio credentials and numbers are stored in config.json. Use for critical alerts only.</div>
    <label style="margin-top:10px;font-size:12px;font-weight:500;">Notification triggers</label>
    <label class="inline"><input type="checkbox" id="twilioTrigOffline"> Offline servers</label>
    <label class="inline"><input type="checkbox" id="twilioTrigWan"> WAN transcodes</label>
    <label class="inline"><input type="checkbox" id="twilioTrigHigh"> High total bandwidth</label>
  </div>

  <div class="section notifier-panel" data-panel="pushover">
    <h2>Pushover</h2>
    <label>
      User key
      <input type="text" id="pushoverUser" placeholder="your Pushover user key">
    </label>
    <label>
      App token
      <input type="text" id="pushoverToken" placeholder="your Pushover API token/ key">
    </label>
    <label>
      Priority (default 0)
      <input type="number" id="pushoverPriority" value="0" style="max-width:120px;">
    </label>
    <label style="margin-top:10px;font-size:12px;font-weight:500;">Notification triggers</label>
    <label class="inline"><input type="checkbox" id="pushoverTrigOffline"> Offline servers</label>
    <label class="inline"><input type="checkbox" id="pushoverTrigWan"> WAN transcodes</label>
    <label class="inline"><input type="checkbox" id="pushoverTrigHigh"> High total bandwidth</label>
  </div>

  <div class="section notifier-panel" data-panel="gotify">
    <h2>Gotify</h2>
    <label>
      Server URL
      <input type="text" id="gotifyServer" placeholder="https://gotify.example.com">
    </label>
    <label>
      App token
      <input type="text" id="gotifyToken" placeholder="Gotify application token">
    </label>
    <label>
      Priority (default 5)
      <input type="number" id="gotifyPriority" value="5" style="max-width:120px;">
    </label>
    <label style="margin-top:10px;font-size:12px;font-weight:500;">Notification triggers</label>
    <label class="inline"><input type="checkbox" id="gotifyTrigOffline"> Offline servers</label>
    <label class="inline"><input type="checkbox" id="gotifyTrigWan"> WAN transcodes</label>
    <label class="inline"><input type="checkbox" id="gotifyTrigHigh"> High total bandwidth</label>
  </div>

  <div class="section notifier-panel" data-panel="email">
    <h2>Email</h2>
    <label class="inline">
      <input type="checkbox" id="emailEnabled"> Enable email notifications
    </label>
    <label>
      From address
      <input type="email" id="emailFrom" placeholder="omnistream@example.com">
    </label>
    <label>
      To address
      <input type="email" id="emailTo" placeholder="you@example.com">
    </label>
    <label>
      SMTP host
      <input type="text" id="smtpHost" placeholder="smtp.example.com">
    </label>
    <label class="inline">
      <span style="flex:1;min-width:0;">
        Port
        <input type="number" id="smtpPort" value="587" style="max-width:120px;">
      </span>
      <span class="inline" style="gap:4px;">
        <input type="checkbox" id="smtpSecure"> Use TLS (secure)
      </span>
    </label>
    <label>
      SMTP username
      <input type="text" id="smtpUser" placeholder="smtp user">
    </label>
    <label>
      SMTP password
      <input type="password" id="smtpPass" placeholder="smtp password">
    </label>
    <div class="hint">Email credentials are stored in config.json on the server. Use a dedicated app password if possible.</div>
    <label style="margin-top:10px;font-size:12px;font-weight:500;">Notification triggers</label>
    <label class="inline"><input type="checkbox" id="emailTrigOffline"> Offline servers</label>
    <label class="inline"><input type="checkbox" id="emailTrigWan"> WAN transcodes</label>
    <label class="inline"><input type="checkbox" id="emailTrigHigh"> High total bandwidth</label>
  </div>

  <button id="saveBtn" class="btn">Save Settings</button>
  <span id="saveStatus" class="status"></span>
  <button id="testBtn" class="btn" style="margin-left:8px;">Send test notification</button>
  <span id="testStatus" class="status"></span>
  <button id="backBtn" class="btn" style="margin-left:8px;">Back to Settings</button>

  <script>
    // Apply saved theme and wire Settings + sidebar toggle
    (function() {
      const savedTheme = localStorage.getItem('omnistreamTheme') || 'default';
      if (savedTheme && savedTheme !== 'default') {
        document.documentElement.setAttribute('data-theme', savedTheme);
      }
      const settingsToggle = document.querySelector('.settings-toggle');
      const settingsSubmenu = document.querySelector('.settings-submenu');
      if (settingsToggle && settingsSubmenu) {
        settingsToggle.addEventListener('click', () => {
          settingsSubmenu.classList.toggle('open');
        });
      }

      const appShell = document.querySelector('.app-shell');
      const sidebarToggle = document.getElementById('sidebarToggle');
      if (appShell && sidebarToggle) {
        const savedSidebar = localStorage.getItem('omnistreamSidebar') || 'open';
        if (savedSidebar === 'collapsed') {
          appShell.classList.add('sidebar-collapsed');
          sidebarToggle.textContent = 'Show menu';
        }
        sidebarToggle.addEventListener('click', () => {
          const collapsed = appShell.classList.toggle('sidebar-collapsed');
          sidebarToggle.textContent = collapsed ? 'Show menu' : 'Hide menu';
          localStorage.setItem('omnistreamSidebar', collapsed ? 'collapsed' : 'open');
        });
      }

      const tabs = document.querySelectorAll('.notifier-tab');
      const panels = document.querySelectorAll('.notifier-panel');
      function showPanel(name) {
        tabs.forEach(tab => {
          tab.classList.toggle('notifier-tab-active', tab.dataset.panel === name);
        });
        panels.forEach(panel => {
          panel.style.display = panel.dataset.panel === name ? 'block' : 'none';
        });
        localStorage.setItem('omnistreamNotifierTab', name);
      }
      if (tabs.length && panels.length) {
        const savedPanel = localStorage.getItem('omnistreamNotifierTab') || 'email';
        showPanel(savedPanel);
        tabs.forEach(tab => {
          tab.addEventListener('click', () => showPanel(tab.dataset.panel));
        });
      }
    })();

    async function loadConfig() {
      try {
        const r = await fetch('/api/config/notifiers');
        const data = await r.json();
        const n = data.notifiers || {};
        const rules = n.rules || {};
        const discord = n.discord || {};
        const email = n.email || {};
        document.getElementById('ruleOffline').checked = rules.offline ? rules.offline.enabled !== false : true;
        document.getElementById('ruleWanTranscodes').checked = rules.wanTranscodes ? rules.wanTranscodes.enabled !== false : true;
        const highRule = rules.highBandwidth || {};
        document.getElementById('ruleHighBandwidth').checked = highRule.enabled !== false;
        document.getElementById('ruleHighBandwidthThreshold').value = highRule.thresholdMbps != null ? highRule.thresholdMbps : 50;
        const anyWanRule = rules.anyWan || {};
        document.getElementById('ruleAnyWan').checked = anyWanRule.enabled === true; // opt-in, default off
        const highWanRule = rules.highWanBandwidth || {};
        document.getElementById('ruleHighWan').checked = highWanRule.enabled !== false;
        document.getElementById('ruleHighWanThreshold').value = highWanRule.thresholdMbps != null ? highWanRule.thresholdMbps : 30;
        document.getElementById('discordWebhook').value = discord.webhookUrl || '';
        document.getElementById('emailEnabled').checked = email.enabled === true;
        document.getElementById('emailFrom').value = email.from || '';
        document.getElementById('emailTo').value = email.to || '';
        const smtp = email.smtp || {};
        document.getElementById('smtpHost').value = smtp.host || '';
        document.getElementById('smtpPort').value = smtp.port || '';
        document.getElementById('smtpSecure').checked = !!smtp.secure;
        const auth = smtp.auth || {};
        document.getElementById('smtpUser').value = auth.user || '';
        document.getElementById('smtpPass').value = auth.pass || '';
        const webhook = n.webhook || {};
        document.getElementById('webhookUrl').value = webhook.url || '';
        const slack = n.slack || {};
        document.getElementById('slackWebhook').value = slack.webhookUrl || '';
        const telegram = n.telegram || {};
        document.getElementById('telegramToken').value = telegram.botToken || '';
        document.getElementById('telegramChat').value = telegram.chatId || '';
        const twilio = n.twilio || {};
        document.getElementById('twilioSid').value = twilio.accountSid || '';
        document.getElementById('twilioToken').value = twilio.authToken || '';
        document.getElementById('twilioFrom').value = twilio.from || '';
        document.getElementById('twilioTo').value = twilio.to || '';
        const pushover = n.pushover || {};
        document.getElementById('pushoverUser').value = pushover.user || '';
        document.getElementById('pushoverToken').value = pushover.token || '';
        document.getElementById('pushoverPriority').value = pushover.priority != null ? pushover.priority : 0;
        const gotify = n.gotify || {};
        document.getElementById('gotifyServer').value = gotify.serverUrl || '';
        document.getElementById('gotifyToken').value = gotify.token || '';
        document.getElementById('gotifyPriority').value = gotify.priority != null ? gotify.priority : 5;

        const emailTrig = email.triggers || {};
        document.getElementById('emailTrigOffline').checked = emailTrig.offline !== false;
        document.getElementById('emailTrigWan').checked = emailTrig.wanTranscodes !== false;
        document.getElementById('emailTrigHigh').checked = emailTrig.highBandwidth !== false;

        const discordTrig = discord.triggers || {};
        document.getElementById('discordTrigOffline').checked = discordTrig.offline !== false;
        document.getElementById('discordTrigWan').checked = discordTrig.wanTranscodes !== false;
        document.getElementById('discordTrigHigh').checked = discordTrig.highBandwidth !== false;

        const webhookTrig = webhook.triggers || {};
        document.getElementById('webhookTrigOffline').checked = webhookTrig.offline !== false;
        document.getElementById('webhookTrigWan').checked = webhookTrig.wanTranscodes !== false;
        document.getElementById('webhookTrigHigh').checked = webhookTrig.highBandwidth !== false;

        const slackTrig = slack.triggers || {};
        document.getElementById('slackTrigOffline').checked = slackTrig.offline !== false;
        document.getElementById('slackTrigWan').checked = slackTrig.wanTranscodes !== false;
        document.getElementById('slackTrigHigh').checked = slackTrig.highBandwidth !== false;

        const telegramTrig = telegram.triggers || {};
        document.getElementById('telegramTrigOffline').checked = telegramTrig.offline !== false;
        document.getElementById('telegramTrigWan').checked = telegramTrig.wanTranscodes !== false;
        document.getElementById('telegramTrigHigh').checked = telegramTrig.highBandwidth !== false;

        const twilioTrig = twilio.triggers || {};
        document.getElementById('twilioTrigOffline').checked = twilioTrig.offline !== false;
        document.getElementById('twilioTrigWan').checked = twilioTrig.wanTranscodes !== false;
        document.getElementById('twilioTrigHigh').checked = twilioTrig.highBandwidth !== false;

        const pushoverTrig = pushover.triggers || {};
        document.getElementById('pushoverTrigOffline').checked = pushoverTrig.offline !== false;
        document.getElementById('pushoverTrigWan').checked = pushoverTrig.wanTranscodes !== false;
        document.getElementById('pushoverTrigHigh').checked = pushoverTrig.highBandwidth !== false;

        const gotifyTrigObj = gotify.triggers || {};
        document.getElementById('gotifyTrigOffline').checked = gotifyTrigObj.offline !== false;
        document.getElementById('gotifyTrigWan').checked = gotifyTrigObj.wanTranscodes !== false;
        document.getElementById('gotifyTrigHigh').checked = gotifyTrigObj.highBandwidth !== false;
      } catch (e) {
        console.error(e);
      }
    }

    async function saveConfig() {
      const statusEl = document.getElementById('saveStatus');
      statusEl.textContent = 'Saving...';
      try {
        const body = {
          rules: {
            offline: { enabled: document.getElementById('ruleOffline').checked },
            wanTranscodes: { enabled: document.getElementById('ruleWanTranscodes').checked },
            highBandwidth: {
              enabled: document.getElementById('ruleHighBandwidth').checked,
              thresholdMbps: Number(document.getElementById('ruleHighBandwidthThreshold').value) || 50
            },
            anyWan: {
              enabled: document.getElementById('ruleAnyWan').checked
            },
            highWanBandwidth: {
              enabled: document.getElementById('ruleHighWan').checked,
              thresholdMbps: Number(document.getElementById('ruleHighWanThreshold').value) || 30
            }
          },
          discord: {
            webhookUrl: document.getElementById('discordWebhook').value.trim() || undefined,
            triggers: {
              offline: document.getElementById('discordTrigOffline').checked,
              wanTranscodes: document.getElementById('discordTrigWan').checked,
              highBandwidth: document.getElementById('discordTrigHigh').checked
            }
          },
          email: {
            enabled: document.getElementById('emailEnabled').checked,
            from: document.getElementById('emailFrom').value.trim() || undefined,
            to: document.getElementById('emailTo').value.trim() || undefined,
            smtp: {
              host: document.getElementById('smtpHost').value.trim() || undefined,
              port: Number(document.getElementById('smtpPort').value) || undefined,
              secure: document.getElementById('smtpSecure').checked,
              auth: {
                user: document.getElementById('smtpUser').value.trim() || undefined,
                pass: document.getElementById('smtpPass').value || undefined
              }
            },
            triggers: {
              offline: document.getElementById('emailTrigOffline').checked,
              wanTranscodes: document.getElementById('emailTrigWan').checked,
              highBandwidth: document.getElementById('emailTrigHigh').checked
            }
          },
          webhook: {
            url: document.getElementById('webhookUrl').value.trim() || undefined,
            triggers: {
              offline: document.getElementById('webhookTrigOffline').checked,
              wanTranscodes: document.getElementById('webhookTrigWan').checked,
              highBandwidth: document.getElementById('webhookTrigHigh').checked
            }
          },
          slack: {
            webhookUrl: document.getElementById('slackWebhook').value.trim() || undefined,
            triggers: {
              offline: document.getElementById('slackTrigOffline').checked,
              wanTranscodes: document.getElementById('slackTrigWan').checked,
              highBandwidth: document.getElementById('slackTrigHigh').checked
            }
          },
          telegram: {
            botToken: document.getElementById('telegramToken').value.trim() || undefined,
            chatId: document.getElementById('telegramChat').value.trim() || undefined,
            triggers: {
              offline: document.getElementById('telegramTrigOffline').checked,
              wanTranscodes: document.getElementById('telegramTrigWan').checked,
              highBandwidth: document.getElementById('telegramTrigHigh').checked
            }
          },
          twilio: {
            accountSid: document.getElementById('twilioSid').value.trim() || undefined,
            authToken: document.getElementById('twilioToken').value || undefined,
            from: document.getElementById('twilioFrom').value.trim() || undefined,
            to: document.getElementById('twilioTo').value.trim() || undefined,
            triggers: {
              offline: document.getElementById('twilioTrigOffline').checked,
              wanTranscodes: document.getElementById('twilioTrigWan').checked,
              highBandwidth: document.getElementById('twilioTrigHigh').checked
            }
          },
          pushover: {
            user: document.getElementById('pushoverUser').value.trim() || undefined,
            token: document.getElementById('pushoverToken').value.trim() || undefined,
            priority: Number(document.getElementById('pushoverPriority').value),
            triggers: {
              offline: document.getElementById('pushoverTrigOffline').checked,
              wanTranscodes: document.getElementById('pushoverTrigWan').checked,
              highBandwidth: document.getElementById('pushoverTrigHigh').checked
            }
          },
          gotify: {
            serverUrl: document.getElementById('gotifyServer').value.trim() || undefined,
            token: document.getElementById('gotifyToken').value.trim() || undefined,
            priority: Number(document.getElementById('gotifyPriority').value),
            triggers: {
              offline: document.getElementById('gotifyTrigOffline').checked,
              wanTranscodes: document.getElementById('gotifyTrigWan').checked,
              highBandwidth: document.getElementById('gotifyTrigHigh').checked
            }
          }
        };
        const resp = await fetch('/api/config/notifiers', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        if (!resp.ok) {
          const text = await resp.text().catch(() => '');
          statusEl.textContent = 'Save failed: ' + (text || resp.status + ' ' + resp.statusText);
          statusEl.style.color = '#ff8a80';
          return;
        }
        statusEl.textContent = 'Saved.';
        statusEl.style.color = '#a5d6a7';
      } catch (e) {
        console.error(e);
        statusEl.textContent = 'Save failed. Check server logs.';
        statusEl.style.color = '#ff8a80';
      }
    }

    async function testNotifiers() {
      const statusEl = document.getElementById('testStatus');
      statusEl.textContent = 'Sending test notification...';
      statusEl.style.color = '';
      try {
        const resp = await fetch('/api/notifiers/test', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });
        if (!resp.ok) {
          const text = await resp.text().catch(() => '');
          statusEl.textContent = 'Test failed: ' + (text || resp.status + ' ' + resp.statusText);
          statusEl.style.color = '#ff8a80';
          return;
        }
        const data = await resp.json().catch(() => ({}));
        const channels = Array.isArray(data.channels) && data.channels.length ? data.channels.join(', ') : 'configured notifiers';
        statusEl.textContent = 'Test notification sent via ' + channels + '. Check your targets to confirm.';
        statusEl.style.color = '#a5d6a7';
      } catch (e) {
        console.error(e);
        statusEl.textContent = 'Test failed. Check server logs.';
        statusEl.style.color = '#ff8a80';
      }
    }

    document.getElementById('saveBtn').onclick = saveConfig;
    document.getElementById('testBtn').onclick = testNotifiers;
    document.getElementById('backBtn').onclick = () => {
      window.location.href = 'admin.html';
    };

    loadConfig();
  </script>
    </main>
  </div>
</body>
</html>
