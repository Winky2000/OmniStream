<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>OmniStream</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root {
      --bg: #181c24;
      --text-main: #e0e3e8;
      --text-muted: #a0a4b0;
      --text-faint: #888;
      --card-bg: #232837;
      --border-offline: #444;
      --btn-bg: #181c24;
      --btn-border: #00bfff;
      --btn-text: #00bfff;
      --btn-bg-hover: #232837;
      --btn-text-hover: #ffffff;
      --plex-color: #00bfff;
      --jellyfin-color: #00ffff;
      --emby-color: #bf00ff;
      --session-direct: #39ff14;
      --session-transcode: #ff073a;
      --progress-fill: #4caf50;
    }

    :root[data-theme="minimal"] {
      --bg: #0f1115;
      --text-main: #f5f5f5;
      --text-muted: #b0b3b8;
      --text-faint: #7a7d86;
      --card-bg: #171a22;
      --border-offline: #3a3d45;
      --btn-bg: #171a22;
      --btn-border: #888;
      --btn-text: #f5f5f5;
      --btn-bg-hover: #20232b;
      --btn-text-hover: #ffffff;
      --plex-color: #4caf50;
      --jellyfin-color: #03a9f4;
      --emby-color: #9c27b0;
      --session-direct: #4caf50;
      --session-transcode: #e53935;
      --progress-fill: #4caf50;
    }

    :root[data-theme="high-contrast"] {
      --bg: #000000;
      --text-main: #ffffff;
      --text-muted: #e0e0e0;
      --text-faint: #bbbbbb;
      --card-bg: #101010;
      --border-offline: #555555;
      --btn-bg: #000000;
      --btn-border: #ffffff;
      --btn-text: #ffffff;
      --btn-bg-hover: #202020;
      --btn-text-hover: #ffffff;
      --plex-color: #00e5ff;
      --jellyfin-color: #76ff03;
      --emby-color: #ff4081;
      --session-direct: #00ff00;
      --session-transcode: #ff1744;
      --progress-fill: #00ff00;
    }

    body{font-family:Segoe UI,Arial;background:var(--bg);color:var(--text-main);margin:0;padding:20px}
    h1{margin:0;color:var(--text-main);letter-spacing:1px;display:inline-block;vertical-align:middle;font-size:2.2em}
    .header-flex{display:flex;align-items:center;gap:18px;margin-bottom:24px;}
    .logo-img{height:135px;max-width:180px;object-fit:contain;box-shadow:0 2px 8px #0003;border-radius:8px;}
    #grid.grid-layout {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      gap: 28px;
      align-items: flex-start;
      justify-content: flex-start;
    }
    #grid.flex-layout {
      display: flex;
      flex-direction: column;
      gap: 28px;
      align-items: center;
    }
    .card.flex-full {
      min-width: 100%;
      max-width: 100%;
      width: 100%;
    }
    .sessions.horizontal-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 18px;
      align-items: flex-start;
    }
    /* Remove forced flex/grid for cards and sessions, revert to original */
    .card {
      background: var(--card-bg);
      border-radius: 18px;
      padding: 32px 32px 28px 32px;
      box-shadow: 0 2px 18px #0004;
      border: 4px solid var(--plex-color);
      min-width: 420px;
      max-width: 520px;
      width: 100%;
      transition: border-color 0.3s, box-shadow 0.3s, min-width 0.3s, max-width 0.3s, padding 0.3s;
    }
    .card.card-plex {
      border-color: var(--plex-color);
      box-shadow: 0 2px 18px #0004, 0 0 24px 6px var(--plex-color), 0 0 18px var(--plex-color);
    }
    .card.card-jellyfin {
      border-color: var(--jellyfin-color);
      box-shadow: 0 2px 18px #0004, 0 0 24px 6px var(--jellyfin-color), 0 0 18px var(--jellyfin-color);
    }
    .card.card-emby {
      border-color: var(--emby-color);
      box-shadow: 0 2px 18px #0004, 0 0 24px 6px var(--emby-color), 0 0 18px var(--emby-color);
    }
    .session {
      background: var(--card-bg);
      border-radius: 8px;
      margin-bottom: 10px;
      padding: 7.2px 7.2px 7.2px 7.2px;
      line-height: 1.4;
      font-size: 13.2px;
    }
    .session-poster {
      width: 59px !important;
      height: 87px !important;
    }
    .session-user {
      font-size: 16.8px !important;
    }
    .session-title {
      font-size: 13.2px !important;
    }
    .session-meta {
      font-size: 12px !important;
    }
    .card.offline {
      border-color: var(--border-offline);
      box-shadow: 0 0 8px var(--border-offline), 0 2px 12px #0004;
    }
    .toggle-btn{background:var(--btn-bg);color:var(--btn-text);border:2px solid var(--btn-border);border-radius:8px;padding:8px 18px;font-size:1em;cursor:pointer;margin-bottom:18px;transition:background 0.2s, color 0.2s, border-color 0.2s;}
    .toggle-btn:hover{background:var(--btn-bg-hover);color:var(--btn-text-hover);}
    .offline{opacity:0.5}
    .title{font-weight:600;margin-bottom:6px;color:var(--text-main)}
    .meta{font-size:13px;color:var(--text-muted);margin-bottom:8px}
    .small{font-size:12px;color:var(--text-faint);margin-bottom:8px}
    .sessions{font-size:11px;border-top:1px solid #222;padding-top:8px;margin-top:8px;display:flex;flex-direction:column;gap:8px;}
    .sessions.flex-sessions{flex-direction:row;flex-wrap:wrap;gap:18px;align-items:flex-start;}
    .session{background:var(--card-bg);padding:6px;border-radius:4px;margin-bottom:4px;line-height:1.4;box-shadow:0 1px 2px #0002}
    .session.direct{border:2px solid var(--session-direct);box-shadow:0 0 12px 2px var(--session-direct),0 1px 2px #0002}
    .session.transcode{border:2px solid var(--session-transcode);box-shadow:0 0 12px 2px var(--session-transcode),0 1px 2px #0002}
    .session-user{font-weight:600;color:#f7c873}
    .session-title{color:var(--text-main);font-size:11px}
    .session-meta{font-size:10px;color:var(--text-muted);margin-bottom:2px}
    .session-poster{float:left;width:59px;height:87px;object-fit:cover;margin-right:8px;border-radius:3px;box-shadow:0 1px 2px #0003}
    .progress-bar{background:#2a2e39;height:4px;border-radius:2px;margin-top:2px;overflow:hidden}
    .progress-fill{background:var(--progress-fill);height:100%;transition:width 0.3s}
  </style>
</head>
<body>
  <div class="header-flex">
    <img src="omnistream_logo.png" alt="OmniStream Logo" class="logo-img" />
    <h1>OmniStream</h1>
    <button class="toggle-btn" id="adminBtn" style="margin-left:24px;">Admin</button>
    <select class="toggle-btn" id="themeSelect" style="margin-left:auto;margin-bottom:0;padding:6px 12px;">
      <option value="default">Neon</option>
      <option value="minimal">Minimal</option>
      <option value="high-contrast">High contrast</option>
    </select>
  </div>
  <button class="toggle-btn" id="layoutToggle">Switch Layout</button>
  <div id="grid" class="grid-layout"></div>
  <div id="grid"></div>

  <script>
    async function fetchStatus() {
      try {
        const r = await fetch('/api/status');
        return await r.json();
      } catch (e) { console.error(e); return {servers: [], statuses: {}} }
    }

    let layoutMode = 'grid';
    document.addEventListener('DOMContentLoaded', () => {
      const toggleBtn = document.getElementById('layoutToggle');
      const adminBtn = document.getElementById('adminBtn');
      const grid = document.getElementById('grid');
      const themeSelect = document.getElementById('themeSelect');

      // Apply saved theme
      const savedTheme = localStorage.getItem('omnistreamTheme') || 'default';
      if (savedTheme && savedTheme !== 'default') {
        document.documentElement.setAttribute('data-theme', savedTheme);
      }
      themeSelect.value = savedTheme;

      themeSelect.addEventListener('change', () => {
        const v = themeSelect.value;
        if (v === 'default') {
          document.documentElement.removeAttribute('data-theme');
        } else {
          document.documentElement.setAttribute('data-theme', v);
        }
        localStorage.setItem('omnistreamTheme', v);
      });
      toggleBtn.addEventListener('click', () => {
        layoutMode = layoutMode === 'grid' ? 'flex' : 'grid';
        grid.className = layoutMode === 'grid' ? 'grid-layout' : 'flex-layout';
        loop();
      });
      adminBtn.addEventListener('click', () => {
        window.location.href = '/admin.html';
      });
      // Set initial layout
      grid.className = 'grid-layout';
    });

    function render(data) {
      const { servers = [], statuses = {}, setup = false } = data;
      const grid = document.getElementById('grid');
      grid.innerHTML = '';
      // Setup mode: no servers configured yet
      if (setup || !servers.length) {
        const card = document.createElement('div');
        card.className = 'card flex-full';
        const title = document.createElement('div');
        title.className = 'title';
        title.textContent = 'Welcome to OmniStream';
        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.innerHTML = 'No servers are configured yet.<br>Add your Plex/Jellyfin/Emby servers to get started.';
        const btn = document.createElement('button');
        btn.className = 'toggle-btn';
        btn.style.marginTop = '16px';
        btn.textContent = 'Start Setup (Servers)';
        btn.onclick = () => { window.location.href = '/servers.html'; };
        card.appendChild(title);
        card.appendChild(meta);
        card.appendChild(btn);
        grid.appendChild(card);
        return;
      }
      servers.forEach(s => {
        const st = statuses && statuses[s.id] ? statuses[s.id] : { online: false };
        const card = document.createElement('div');
        const typeClass = s.type ? ('card-' + s.type.toLowerCase()) : '';
        card.className = 'card ' + typeClass + ' ' + (st.online ? '' : 'offline') + (layoutMode === 'flex' ? ' flex-full' : '');
        // In flex (horizontal) mode, cards are 100% width; in grid (vertical), cards are full width
        if (layoutMode === 'flex') {
          card.style.minWidth = '100%';
          card.style.maxWidth = '100%';
          card.style.width = '100%';
        } else {
          card.style.minWidth = '420px';
          card.style.maxWidth = '520px';
          card.style.width = '100%';
        }

        const title = document.createElement('div'); title.className = 'title';
        title.textContent = s.name || s.baseUrl;

        const meta = document.createElement('div'); meta.className = 'meta';
        meta.textContent = `${s.type || 'generic'} \u2022 ${st.online ? 'Online' : 'Offline'}`;

        const small = document.createElement('div'); small.className = 'small';
        small.innerHTML = `Latency: ${st.latency ?? '-'}ms<br/>Last: ${st.lastChecked ? new Date(st.lastChecked).toLocaleTimeString() : '-'}`;

        card.appendChild(title); 
        card.appendChild(meta); 
        card.appendChild(small);
        // Session summary with totals (always show, default to zero if missing)
        if (st.online) {
          const summary = st.summary || {};
          const directPlays = typeof summary.directPlays === 'number' ? summary.directPlays : 0;
          const transcodes = typeof summary.transcodes === 'number' ? summary.transcodes : 0;
          // Always use st.sessions.length for totalStreams if available
          const totalStreams = st.sessions && Array.isArray(st.sessions) ? st.sessions.length : (typeof summary.totalStreams === 'number' ? summary.totalStreams : 0);
          // If summary.totalBandwidth is zero, sum from sessions
          let totalBandwidth = typeof summary.totalBandwidth === 'number' ? summary.totalBandwidth : 0;
          if (totalBandwidth === 0 && st.sessions && Array.isArray(st.sessions)) {
            totalBandwidth = st.sessions.reduce((sum, sess) => sum + (typeof sess.bandwidth === 'number' ? sess.bandwidth : 0), 0);
          }
          let lanBandwidth = typeof summary.lanBandwidth === 'number' ? summary.lanBandwidth : 0;
          let wanBandwidth = typeof summary.wanBandwidth === 'number' ? summary.wanBandwidth : 0;
          // If LAN/WAN bandwidth is zero, sum from sessions
          if (lanBandwidth === 0 && st.sessions && Array.isArray(st.sessions)) {
            lanBandwidth = st.sessions.reduce((sum, sess) => sum + (sess.location && sess.location.toUpperCase().includes('LAN') && typeof sess.bandwidth === 'number' ? sess.bandwidth : 0), 0);
          }
          if (wanBandwidth === 0 && st.sessions && Array.isArray(st.sessions)) {
            wanBandwidth = st.sessions.reduce((sum, sess) => sum + (sess.location && sess.location.toUpperCase().includes('WAN') && typeof sess.bandwidth === 'number' ? sess.bandwidth : 0), 0);
          }
          const summaryDiv = document.createElement('div');
          summaryDiv.className = 'meta';
          summaryDiv.innerHTML = `Total Streams: <b>${totalStreams}</b> &nbsp;|&nbsp; Direct Play: <b>${directPlays}</b> &nbsp;|&nbsp; Transcoding: <b>${transcodes}</b><br>Bandwidth: ${totalBandwidth.toFixed(1)} Mbps (LAN: ${lanBandwidth.toFixed(1)} Mbps, WAN: ${wanBandwidth.toFixed(1)} Mbps)`;
          card.appendChild(summaryDiv);
        }
        // Sessions
        if (st.online && st.sessions && st.sessions.length > 0) {
          const sessionsDiv = document.createElement('div');
          sessionsDiv.className = 'sessions' + (layoutMode === 'flex' ? ' horizontal-grid' : '');
          // Filter out any completely empty session objects so we don't render blank cards
          const visibleSessions = st.sessions.filter(sess => sess && (sess.poster || sess.title || sess.user || sess.userName));
          visibleSessions.forEach(sess => {
            const session = document.createElement('div');
            // Classify direct play vs transcode for border color
            let isTranscoding = false;
            if (typeof sess.transcoding === 'boolean') {
              isTranscoding = sess.transcoding;
            } else if (sess.stream && typeof sess.stream === 'string' && sess.stream.toLowerCase().includes('transcode')) {
              isTranscoding = true;
            } else if (sess.state && typeof sess.state === 'string' && sess.state.toLowerCase().includes('transcode')) {
              isTranscoding = true;
            }
            session.className = 'session ' + (isTranscoding ? 'transcode' : 'direct');
            // Layout: poster left, info right (horizontal) or stacked (vertical)
            const row = document.createElement('div');
            row.style.display = layoutMode === 'flex' ? 'flex' : 'block';
            row.style.alignItems = 'flex-start';
            // Poster
            if (sess.poster) {
              const img = document.createElement('img');
              img.className = 'session-poster';
              img.src = sess.poster;
              img.alt = 'Poster';
              img.onerror = function() { this.style.display = 'none'; };
              if (layoutMode === 'flex') row.appendChild(img);
              else session.appendChild(img);
            }
            // Info block
            const info = document.createElement('div');
            info.style.display = 'flex';
            info.style.flexDirection = 'column';
            info.style.marginLeft = layoutMode === 'flex' ? '10px' : '0';
            // User and title
            const title = document.createElement('div');
            title.className = 'session-user';
            title.textContent = sess.user || sess.userName || 'Unknown';
            // Direct Play/Transcoding label
            const streamType = document.createElement('span');
            streamType.style = 'margin-left:8px;font-size:11px;padding:2px 8px;border-radius:6px;font-weight:600;display:inline-block;';
            if (isTranscoding) {
              streamType.textContent = 'Transcoding';
              streamType.style.background = 'var(--session-transcode)';
              streamType.style.color = '#ffffff';
            } else {
              streamType.textContent = 'Direct Play';
              streamType.style.background = 'var(--session-direct)';
              streamType.style.color = '#000000';
            }
            title.appendChild(streamType);
            info.appendChild(title);
            // TV show: show grandparentTitle as main title, and season/episode line
            let showTitle = sess.grandparentTitle || sess.title || sess.channel || 'Idle';
            const sub = document.createElement('div');
            sub.className = 'session-title';
            sub.textContent = showTitle;
            info.appendChild(sub);
            // If TV show, add season/episode line
            if (sess.grandparentTitle && (sess.parentIndex || sess.index)) {
              const seLine = document.createElement('div');
              seLine.className = 'session-meta';
              let seText = '';
              if (sess.parentIndex) seText += 'Season ' + sess.parentIndex;
              if (sess.index) seText += (seText ? ' â€¢ ' : '') + 'Episode ' + sess.index;
              seLine.textContent = seText;
              info.appendChild(seLine);
            }
            // Info list
            const infoList = document.createElement('div');
            infoList.style.fontSize = '11px';
            infoList.style.color = '#b0b3b8';
            infoList.style.display = 'flex';
            infoList.style.flexDirection = 'column';
            infoList.style.gap = '2px';
            function addInfo(label, value) {
              if (value) {
                const div = document.createElement('div');
                div.innerHTML = `<b>${label}:</b> ${value}`;
                infoList.appendChild(div);
              }
            }
            addInfo('Product', sess.product);
            addInfo('Player', sess.player);
            addInfo('Quality', sess.quality);
            addInfo('Stream', sess.stream);
            addInfo('Container', sess.container);
            addInfo('Video', sess.video);
            addInfo('Audio', sess.audio);
            addInfo('Subtitle', sess.subtitle);
            addInfo('Location', sess.location);
            if (sess.location && sess.location.toUpperCase().includes('WAN')) {
              addInfo('WAN', sess.ip);
            }
            if (typeof sess.bandwidth === 'number' && sess.bandwidth > 0) {
              addInfo('Bandwidth', sess.bandwidth.toFixed(1) + ' Mbps');
            }
            info.appendChild(infoList);
            row.appendChild(info);
            // Append the combined row for both layouts so sessions never appear empty
            session.appendChild(row);
            // Progress bar
            const bar = document.createElement('div');
            bar.className = 'progress-bar';
            const fill = document.createElement('div');
            fill.className = 'progress-fill';
            fill.style.width = (sess.progress || 0) + '%';
            bar.appendChild(fill);
            session.appendChild(bar);
            sessionsDiv.appendChild(session);
          });
          if (visibleSessions.length > 0) {
            card.appendChild(sessionsDiv);
          }
        }
        grid.appendChild(card);
      });
    }

    async function loop() {
      const data = await fetchStatus();
      render(data);
    }

    loop();
    setInterval(loop, 5000);
  </script>
</body>
</html>
