<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>OmniStream</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:Segoe UI,Arial;background:#181c24;color:#e0e3e8;margin:0;padding:20px}
    h1{margin:0;color:#fff;letter-spacing:1px;display:inline-block;vertical-align:middle;font-size:2.2em}
    .header-flex{display:flex;align-items:center;gap:18px;margin-bottom:24px;}
    .logo-img{height:90px;max-width:120px;object-fit:contain;box-shadow:0 2px 8px #0003;border-radius:8px;}
    #grid.grid-layout {
      display: flex;
      flex-direction: column;
      gap: 28px;
      align-items: center;
    }
    #grid.flex-layout {
      display: flex;
      flex-direction: row;
      flex-wrap: nowrap;
      gap: 28px;
      overflow-x: auto;
      scrollbar-color: #00bfff #232837;
      scrollbar-width: thin;
      align-items: flex-start;
    }
    .card {
      background: #232837;
      border-radius: 18px;
      padding: 32px 32px 28px 32px;
      box-shadow: 0 2px 18px #0004, 0 0 18px #00bfff44;
      border: 4px solid #00bfff;
      min-width: 420px;
      max-width: 520px;
      width: 100%;
      transition: border-color 0.3s, box-shadow 0.3s, min-width 0.3s, max-width 0.3s, padding 0.3s;
    }
    .card.offline {
      border-color: #444;
      box-shadow: 0 0 8px #444, 0 2px 12px #0004;
    }
    .toggle-btn{background:#181c24;color:#00bfff;border:2px solid #00bfff;border-radius:8px;padding:8px 18px;font-size:1em;cursor:pointer;margin-bottom:18px;transition:background 0.2s, color 0.2s;}
    .toggle-btn:hover{background:#232837;color:#fff;}
    .offline{opacity:0.5}
    .title{font-weight:600;margin-bottom:6px;color:#fff}
    .meta{font-size:13px;color:#a0a4b0;margin-bottom:8px}
    .small{font-size:12px;color:#888;margin-bottom:8px}
    .sessions{font-size:11px;border-top:1px solid #222;padding-top:8px;margin-top:8px}
    .session{background:#232837;padding:6px;border-radius:4px;margin-bottom:4px;line-height:1.4;box-shadow:0 1px 2px #0002}
    .session-user{font-weight:600;color:#f7c873}
    .session-title{color:#e0e3e8;font-size:11px}
    .session-meta{font-size:10px;color:#b0b3b8;margin-bottom:2px}
    .session-poster{float:left;width:38px;height:56px;object-fit:cover;margin-right:8px;border-radius:3px;box-shadow:0 1px 2px #0003}
    .progress-bar{background:#2a2e39;height:4px;border-radius:2px;margin-top:2px;overflow:hidden}
    .progress-fill{background:#4CAF50;height:100%;transition:width 0.3s}
  </style>
</head>
<body>
  <div class="header-flex">
    <img src="omnistream_logo.png" alt="OmniStream Logo" class="logo-img" />
    <h1>OmniStream</h1>
  </div>
  <button class="toggle-btn" id="layoutToggle">Switch Layout</button>
  <div id="grid" class="grid-layout"></div>
  <div id="grid"></div>

  <script>
    async function fetchStatus() {
      try {
        const r = await fetch('/api/status');
        return await r.json();
      } catch (e) { console.error(e); return {servers: [], statuses: {}} }
    }

    let layoutMode = 'grid';
    document.addEventListener('DOMContentLoaded', () => {
      const toggleBtn = document.getElementById('layoutToggle');
      const grid = document.getElementById('grid');
      toggleBtn.addEventListener('click', () => {
        layoutMode = layoutMode === 'grid' ? 'flex' : 'grid';
        grid.className = layoutMode === 'grid' ? 'grid-layout' : 'flex-layout';
        loop();
      });
      // Set initial layout
      grid.className = 'grid-layout';
    });

    function render(data) {
      const { servers = [], statuses = {} } = data;
      const grid = document.getElementById('grid');
      grid.innerHTML = '';
      servers.forEach(s => {
        const st = statuses && statuses[s.id] ? statuses[s.id] : { online: false };
        const card = document.createElement('div');
        card.className = 'card ' + (st.online ? '' : 'offline');
        // In flex (horizontal) mode, cards are fixed width; in grid (vertical), cards are full width
        if (layoutMode === 'flex') {
          card.style.minWidth = '420px';
          card.style.maxWidth = '520px';
          card.style.width = '420px';
        } else {
          card.style.minWidth = '420px';
          card.style.maxWidth = '520px';
          card.style.width = '100%';
        }

        const title = document.createElement('div'); title.className = 'title';
        title.textContent = s.name || s.baseUrl;

        const meta = document.createElement('div'); meta.className = 'meta';
        meta.textContent = `${s.type || 'generic'} \u2022 ${st.online ? 'Online' : 'Offline'}`;

        const small = document.createElement('div'); small.className = 'small';
        small.innerHTML = `Latency: ${st.latency ?? '-'}ms<br/>Last: ${st.lastChecked ? new Date(st.lastChecked).toLocaleTimeString() : '-'}`;

        card.appendChild(title); 
        card.appendChild(meta); 
        card.appendChild(small);
        // Session summary with totals
        if (st.online && st.summary) {
          const summaryDiv = document.createElement('div');
          summaryDiv.className = 'meta';
          summaryDiv.innerHTML = `Total Streams: <b>${st.count}</b> &nbsp;|&nbsp; Direct Play: <b>${st.summary.directPlays}</b> &nbsp;|&nbsp; Transcoding: <b>${st.summary.transcodes}</b><br>Bandwidth: ${st.summary.totalBandwidth.toFixed(1)} Mbps (LAN: ${st.summary.lanBandwidth.toFixed(1)} Mbps, WAN: ${st.summary.wanBandwidth.toFixed(1)} Mbps)`;
          card.appendChild(summaryDiv);
        }
        // Sessions
        if (st.online && st.sessions && st.sessions.length > 0) {
          const sessionsDiv = document.createElement('div'); 
          sessionsDiv.className = 'sessions';
          sessionsDiv.innerHTML = `<strong>${st.sessions.length} active</strong>`;
          st.sessions.forEach(sess => {
            const session = document.createElement('div'); 
            session.className = 'session';
            // Poster
            if (sess.poster) {
              const img = document.createElement('img');
              img.className = 'session-poster';
              img.src = sess.poster;
              img.alt = 'Poster';
              img.onerror = function() { this.style.display = 'none'; };
              session.appendChild(img);
            }
            // User and title
            const title = document.createElement('div'); 
            title.className = 'session-user';
            title.textContent = sess.user || sess.userName || 'Unknown';
            // Direct Play/Transcoding label
            const streamType = document.createElement('span');
            streamType.style = 'margin-left:8px;font-size:11px;padding:2px 8px;border-radius:6px;';
            if (sess.stream && sess.stream.toLowerCase().includes('direct')) {
              streamType.textContent = 'Direct Play';
              streamType.style.background = '#0ff2';
              streamType.style.color = '#00bfff';
              streamType.style.border = '1px solid #00bfff';
            } else if (sess.stream && sess.stream.toLowerCase().includes('transcode')) {
              streamType.textContent = 'Transcoding';
              streamType.style.background = '#0af2';
              streamType.style.color = '#fff';
              streamType.style.border = '1px solid #0af';
            }
            title.appendChild(streamType);
            const sub = document.createElement('div'); 
            sub.className = 'session-title';
            sub.textContent = sess.title || sess.channel || 'Idle';
            // Meta info
            const meta = document.createElement('div');
            meta.className = 'session-meta';
            meta.innerHTML =
              (sess.episode ? `<b>Ep:</b> ${sess.episode} ` : '') +
              (sess.episodeTitle ? `<b>EpTitle:</b> ${sess.episodeTitle} ` : '') +
              (sess.year ? `<b>Year:</b> ${sess.year} ` : '') +
              (sess.platform ? `<b>Platform:</b> ${sess.platform} ` : '') +
              (sess.product ? `<b>Product:</b> ${sess.product} ` : '') +
              (sess.player ? `<b>Player:</b> ${sess.player} ` : '') +
              (sess.quality ? `<b>Quality:</b> ${sess.quality} ` : '') +
              (sess.stream ? `<b>Stream:</b> ${sess.stream} ` : '') +
              (sess.container ? `<b>Container:</b> ${sess.container} ` : '') +
              (sess.video ? `<b>Video:</b> ${sess.video} ` : '') +
              (sess.audio ? `<b>Audio:</b> ${sess.audio} ` : '') +
              (sess.subtitle ? `<b>Subtitle:</b> ${sess.subtitle} ` : '') +
              (sess.location ? `<b>Location:</b> ${sess.location} ` : '') +
              (sess.ip ? `<b>IP:</b> ${sess.ip} ` : '') +
              (sess.bandwidth ? `<b>Bandwidth:</b> ${sess.bandwidth} Mbps ` : '');
            // Progress bar
            const bar = document.createElement('div'); 
            bar.className = 'progress-bar';
            const fill = document.createElement('div'); 
            fill.className = 'progress-fill';
            fill.style.width = (sess.progress || 0) + '%';
            bar.appendChild(fill);
            session.appendChild(title); 
            session.appendChild(sub);
            session.appendChild(meta);
            session.appendChild(bar);
            sessionsDiv.appendChild(session);
          });
          card.appendChild(sessionsDiv);
        }
        grid.appendChild(card);
      });
    }

    async function loop() {
      const data = await fetchStatus();
      render(data);
    }

    loop();
    setInterval(loop, 5000);
  </script>
</body>
</html>
